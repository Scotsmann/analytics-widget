<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Betting Analysis Widget</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        .analytics-widget {
            border: 2px solid #1E3A8A;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            padding: 10px;
            background-color: #F3F4F6;
            width: 100%;
            height: 320px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .analytics-widget h3 {
            font-size: 14px;
            margin: 0 0 8px;
            color: #fff;
            text-align: center;
            font-weight: 600;
            background-color: #1E3A8A;
            padding: 6px 0;
            border-radius: 4px;
        }
        .analytics-widget select {
            font-size: 12px;
            padding: 4px;
            width: 100%;
            margin-bottom: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
        }
        .analytics-widget table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 8px;
            background-color: #fff;
        }
        .analytics-widget th, .analytics-widget td {
            padding: 4px;
            border: 1px solid #E5E7EB;
            text-align: left;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .analytics-widget th {
            background-color: #3B82F6;
            color: #fff;
            font-weight: 600;
        }
        .analytics-widget .subheader {
            font-size: 12px;
            font-weight: 600;
            margin: 8px 0;
            color: #1E3A8A;
            background-color: #EBF4FF;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .analytics-widget .error {
            color: #DC2626;
            font-size: 12px;
            background-color: #FEF2F2;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #FECACA;
        }
        .analytics-widget canvas {
            max-height: 180px;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="analytics-widget">
    <h3>Client Custom Widget</h3>
    <select id="analysis-type" onchange="renderAnalysis()">
        <option value="metrics">Metrics</option>
        <option value="sport_breakdown">Sport Breakdown</option>
        <option value="wager_type_breakdown">Wager Type Breakdown</option>
        <option value="odds_breakdown">Odds Breakdown</option>
        <option value="popular_selections">Popular Selections</option>
        <option value="game_timing">Game Timing</option>
    </select>
    <div id="betting-analysis-result"></div>
</div>

<script>
let apiResults = null;
let myChart = null;

// Listen for API messages
window.addEventListener('message', function (event) {
    const allowedOrigins = [
        "https://scotsmann.github.io",
        "http://localhost:8501"
    ];
    if (!allowedOrigins.includes(event.origin)) return;

    if (event.data && event.data.type === 'bettingResults') {
        apiResults = event.data.results; // already aggregated
        renderAnalysis();
    }
});

function createTable(data) {
    if (!Array.isArray(data) || data.length === 0) {
        return document.createTextNode("No data available");
    }
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    Object.keys(data[0]).forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    data.forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(val => {
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    return table;
}

function createKeyValueTable(data) {
    const table = document.createElement('table');
    const tbody = document.createElement('tbody');
    for (const [key, value] of Object.entries(data)) {
        const tr = document.createElement('tr');
        const tdKey = document.createElement('td');
        tdKey.textContent = key;
        const tdVal = document.createElement('td');
        tdVal.textContent = value;
        tr.appendChild(tdKey);
        tr.appendChild(tdVal);
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
}

function createPieChart(labels, values, title) {
    const canvas = document.createElement('canvas');
    if (myChart) myChart.destroy();
    myChart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{ data: values, backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#6366F1'] }]
        },
        options: { plugins: { title: { display: true, text: title } } }
    });
    return canvas;
}

function createBarChart(labels, values, title, yLabel) {
    const canvas = document.createElement('canvas');
    if (myChart) myChart.destroy();
    myChart = new Chart(canvas, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: yLabel, data: values, backgroundColor: '#3B82F6' }] },
        options: { plugins: { title: { display: true, text: title } } }
    });
    return canvas;
}

function renderAnalysis() {
    const resultDiv = document.getElementById('betting-analysis-result');
    resultDiv.innerHTML = '';
    if (!apiResults) {
        resultDiv.innerHTML = `<div class="error">No API data received.</div>`;
        return;
    }
    const analysisType = document.getElementById('analysis-type').value;

    if (analysisType === 'metrics') {
        resultDiv.appendChild(createKeyValueTable(apiResults.metrics));
    } else if (analysisType === 'sport_breakdown') {
        resultDiv.appendChild(createTable(apiResults.sport_breakdown));
        resultDiv.appendChild(createPieChart(
            apiResults.sport_breakdown.map(r => r.Sport),
            apiResults.sport_breakdown.map(r => r['Bet Count']),
            "Sport Breakdown"
        ));
    } else if (analysisType === 'wager_type_breakdown') {
        resultDiv.appendChild(createTable(apiResults.wager_type_breakdown));
        resultDiv.appendChild(createPieChart(
            apiResults.wager_type_breakdown.map(r => r['Wager Type']),
            apiResults.wager_type_breakdown.map(r => r['Bet Count']),
            "Wager Type Breakdown"
        ));
    } else if (analysisType === 'odds_breakdown') {
        resultDiv.appendChild(createTable(apiResults.odds_breakdown));
        resultDiv.appendChild(createPieChart(
            apiResults.odds_breakdown.map(r => r['Odds Range']),
            apiResults.odds_breakdown.map(r => r['Bet Count']),
            "Odds Breakdown"
        ));
    } else if (analysisType === 'popular_selections') {
        resultDiv.appendChild(createTable(apiResults.popular_selections));
        resultDiv.appendChild(createBarChart(
            apiResults.popular_selections.map(r => r.Selection),
            apiResults.popular_selections.map(r => r['Ticket Count']),
            "Popular Selections",
            "Ticket Count"
        ));
    } else if (analysisType === 'game_timing') {
        resultDiv.appendChild(createKeyValueTable(apiResults.game_timing));
        resultDiv.appendChild(createBarChart(
            Object.keys(apiResults.game_timing.time_bins),
            Object.values(apiResults.game_timing.time_bins),
            "Game Timing",
            "Bet Count"
        ));
    }
}
</script>
</body>
</html>
